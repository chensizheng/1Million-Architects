 要具备架构的思维模型-以不变应万变

### 1、哲学是什么？
- Philosophy

就是对智慧的热爱；

哲学是智慧，人生有了深刻的阅历，才会真正拥有智慧；

接触更多技术行业的知识（常识），有了知识不等于拥有智慧，智慧是超越常识的。（要在学习的过程中把知识融合成自己的知识体系，形成自己的智慧，在面对具体的业务场景的时候才能如鱼得水）。



### 2、互联网架构设计哲学本质是什么？

- 架构设计哲学就是架构设计智慧

面对业务场景，能给出优雅的设计方案，降本增效。



- 如何拥有架构设计哲学？

思考问题本质，思考第一性原理；

产品提出一个需求，能不能得出需求的本质是什么，进而得出优雅的架构设计方案；



- 第一性原理（亚里士多德）

是一个最基本的命题或者假设，不能被省略，也不能被违反；

通过现象，看透事物本质，发现真正的需求；



生物学的第一性原理：物竞天择，适者生存

经济学第一性原理：供求关系

牛顿的第一性原理：万有引力

架构的第一性原理：降本增效



- 分布式锁的哲学案例：

Redis分布式锁

分布式锁是CP模型，redis是AP模型 （主从架构可能T1、T2都能获得锁）

到底真实的场景是否适合CP还是AP模型，脱离场景谈架构就是耍流氓。

交易领域一定是CP模型、聊天可以是AP模型。



- 分布式锁的使用场景举例

  - 交易库存锁定
    - 防止重复下单或多次秒杀
  - MQ消息去重
    - 服务端发送消息，比如因为ack超时，恰巧kafaka配置了重试次数MAX，可能重复发送
    - 消费端消费消息的幂等性处理
      - RDBMS的unique key 、primary key等
      - redis分布式锁 setnx  （key可以使消息的业务ID）

  - 订单状态协同
    - 防止同时支付和改价同时操作，避免数据不一致，做串行处理

- 业务场景共性
  - 共享资源
  - 解决方案
    - 资源互斥、资源串行化
  - 问题转化
    - 本地锁的弊端
    - 分布式锁



### 3、电商交易业务场景技术融合本质、如何优雅设计

- 分布式事务解决方案

  - 分布式事务 -> 长事务
  - 本地事务 -> 短事务
  - 一个长事务换成多个短事务
  - 失败后补偿处理

- 关于重试技术

  - 数据访问层重试 -  OK  幂等
  - 业务逻辑层重试 -  OK  
  - 网关层重试-  最好不要（订单id的生成）

  

- 关于幂等技术

  - 数据访问层重试

    - 需要 （比如用primary key做去重，引申：update delete怎么做幂等）

  - 业务逻辑重试

    - 不需要 （操作数据是通过数据访问层）

  - 网关层重试

    - 不需要

      

- 关于负载均衡技术

  - 数据访问层重试策略
  - 业务逻辑层重试策略
  - 网关重试策略



- 关于隔离级别技术
  - ACID中的Isolation
    - Read-Uncommit / Read-Commit/Repeatable-Read/Serializable
    - MySQL事务隔离级别

| 事务隔离级别                 | 脏读 | 不可重复读 | 幻读 |
| ---------------------------- | ---- | ---------- | ---- |
| 读未提交（read-uncommitted） | 是   | 是         | 是   |
| 不可重复读（read-committed） | 否   | 是         | 是   |
| 可重复读（repeatable-read）  | 否   | 否         | 是   |
| 串行化（serializable）       | 否   | 否         | 否   |

脏读：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据

不可重复读：事务 A 多次读取同一数据，事务 B 在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果 不一致。

幻读：系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这就叫幻读。

小结：不可重复读的和幻读很容易混淆，不可重复读侧重于修改，幻读侧重于新增或删除。解决不可重复读的问题只需锁住满足条件的行，解决幻读需要锁表

- - APP 重试策略
    - 取决于隔离级别


- 关于熔断技术
  - 网关熔断交易业务逻辑鞥
    - 超时一次
    - 多次超时
  - 网关重试策略
    - 不同交易业务逻辑



# 大道至简









